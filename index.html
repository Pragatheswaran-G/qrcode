<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ME-QR Scanner to ThingSpeak</title>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Arial, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #eee;
        }
        
        h1 {
            color: #4a5568;
            margin-bottom: 10px;
        }
        
        .cloud-status {
            background: #e8f4ff;
            padding: 15px;
            border-radius: 10px;
            margin: 20px 0;
            border-left: 4px solid #48bb78;
        }
        
        .scanner-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .scanner-container {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 10px;
            background: #2d3748;
            margin-bottom: 20px;
        }
        
        #video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transform: scaleX(-1);
        }
        
        .scan-frame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 200px;
            height: 200px;
            border: 3px solid #667eea;
            border-radius: 10px;
            box-shadow: 0 0 0 1000px rgba(0,0,0,0.3);
        }
        
        .scan-line {
            position: absolute;
            height: 3px;
            width: 190px;
            background: #667eea;
            top: 40%;
            animation: scan 2s infinite linear;
        }
        
        @keyframes scan {
            0% { top: 10%; }
            50% { top: 80%; }
            100% { top: 10%; }
        }
        
        .controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            background: #667eea;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            min-width: 120px;
        }
        
        button:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
        }
        
        button:disabled {
            background: #a0aec0;
            cursor: not-allowed;
            transform: none;
        }
        
        button.success {
            background: #48bb78;
        }
        
        button.success:hover {
            background: #38a169;
        }
        
        .data-display {
            background: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        
        .qr-content {
            font-family: monospace;
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            word-break: break-all;
        }
        
        .api-response {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .instructions {
            background: #fff5f5;
            padding: 20px;
            border-radius: 10px;
            margin-top: 30px;
        }
        
        .format-examples {
            background: #f0fff4;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
        
        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .status-ok { background: #48bb78; }
        .status-warning { background: #ed8936; }
        .status-critical { background: #e53e3e; }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ME-QR Scanner to ThingSpeak</h1>
            <p>Scan QR codes from ME-QR website and store in cloud</p>
        </header>
        
        <div class="cloud-status">
            <h3>‚úÖ ThingSpeak Cloud Connected</h3>
            <p><strong>API Key:</strong> NCKHMMR0985GO35B</p>
            <p><strong>Status:</strong> Ready to scan ME-QR codes</p>
        </div>
        
        <div class="scanner-section">
            <h2>QR Code Scanner</h2>
            
            <div class="scanner-container">
                <video id="video" autoplay playsinline></video>
                <div class="scan-frame">
                    <div class="scan-line"></div>
                </div>
            </div>
            
            <div class="controls">
                <button id="startCamera">üì∑ Start Camera</button>
                <button id="stopCamera" disabled>‚èπÔ∏è Stop Camera</button>
                <button id="scanQR" disabled>üîç Scan QR Code</button>
                <button id="saveToCloud" class="success" disabled>‚òÅÔ∏è Save to ThingSpeak</button>
            </div>
            
            <div class="data-display">
                <h3>Scanned ME-QR Content</h3>
                <div class="qr-content" id="scannedData">No QR code scanned yet</div>
                
                <div id="parsedData">
                    <!-- Parsed data will appear here -->
                </div>
            </div>
            
            <div class="format-examples">
                <h4>üìù ME-QR Format Support:</h4>
                <p><strong>Text Format:</strong> <code>Product: Biscuit, Expiry: 20/11/2026, Batch: BATCH001</code></p>
                <p><strong>JSON Format:</strong> <code>{"product":"Biscuit","expiry":"20/11/2026","batch":"BATCH001"}</code></p>
                <p><strong>CSV Format:</strong> <code>Biscuit,20/11/2026,BATCH001</code></p>
            </div>
        </div>
        
        <div class="scanner-section">
            <h2>Cloud Storage Log</h2>
            <div class="api-response" id="apiResponse">
                // ME-QR Scanner ready. Start camera and scan your QR codes.
                [System] Supports multiple formats from ME-QR website
            </div>
        </div>
        
        <div class="instructions">
            <h3>How to Create QR Codes on ME-QR Website:</h3>
            <ol>
                <li>Go to <a href="https://www.me-qr.com/" target="_blank">me-qr.com</a></li>
                <li>Choose "Text" or "URL" option</li>
                <li>Enter your product data in one of these formats:
                    <ul>
                        <li><code>Product: Biscuit, Expiry: 20/11/2026, Batch: BATCH001</code></li>
                        <li><code>{"product":"Biscuit","expiry":"20/11/2026","batch":"BATCH001"}</code></li>
                        <li><code>Biscuit,20/11/2026,BATCH001</code></li>
                    </ul>
                </li>
                <li>Generate and download the QR code</li>
                <li>Print and attach to your products</li>
                <li>Scan using this page to store in ThingSpeak</li>
            </ol>
            
            <h3>ThingSpeak Field Mapping:</h3>
            <p><strong>Field 1:</strong> Product Name</p>
            <p><strong>Field 2:</strong> Expiry Date</p>
            <p><strong>Field 3:</strong> Days Remaining</p>
            <p><strong>Field 4:</strong> Alert Status</p>
        </div>
    </div>

    <script>
        // Your ThingSpeak Configuration
        const THINGSPEAK_API_KEY = "NCKHMMR0985GO35B";
        const THINGSPEAK_URL = "https://api.thingspeak.com/update";
        
        // Global variables
        let video = document.getElementById('video');
        let stream = null;
        let currentScanData = null;
        
        // DOM elements
        const startCamera = document.getElementById('startCamera');
        const stopCamera = document.getElementById('stopCamera');
        const scanQR = document.getElementById('scanQR');
        const saveToCloud = document.getElementById('saveToCloud');
        const scannedData = document.getElementById('scannedData');
        const parsedData = document.getElementById('parsedData');
        const apiResponse = document.getElementById('apiResponse');
        
        // Start camera
        startCamera.addEventListener('click', async function() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "environment" } 
                });
                video.srcObject = stream;
                
                startCamera.disabled = true;
                stopCamera.disabled = false;
                scanQR.disabled = false;
                
                logResponse('üì∑ Camera started successfully');
                logResponse('üëâ Point camera at ME-QR code and click "Scan QR Code"');
            } catch (err) {
                logResponse('‚ùå Camera error: ' + err.message);
            }
        });
        
        // Stop camera
        stopCamera.addEventListener('click', function() {
            if (stream) {
                stream.getTracks().forEach(track => track.stop());
                stream = null;
            }
            
            startCamera.disabled = false;
            stopCamera.disabled = true;
            scanQR.disabled = true;
            saveToCloud.disabled = true;
            
            logResponse('‚èπÔ∏è Camera stopped');
        });
        
        // Scan QR code
        scanQR.addEventListener('click', function() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                context.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    processMEQRData(code.data);
                } else {
                    logResponse('‚ùå No QR code detected. Try again.');
                }
            }
        });
        
        // Process ME-QR data (supports multiple formats)
        function processMEQRData(data) {
            scannedData.textContent = data;
            saveToCloud.disabled = false;
            
            let productData = {
                product: "Unknown Product",
                expiry: getDefaultExpiry(),
                batch: "",
                category: ""
            };
            
            logResponse('üîç Analyzing ME-QR content...');
            
            // Try different parsing methods
            if (tryParseJSON(data, productData)) {
                logResponse('‚úÖ JSON format detected and parsed');
            } else if (tryParseTextFormat(data, productData)) {
                logResponse('‚úÖ Text format detected and parsed');
            } else if (tryParseCSV(data, productData)) {
                logResponse('‚úÖ CSV format detected and parsed');
            } else {
                // Default: use entire text as product name
                productData.product = data.substring(0, 50);
                logResponse('‚ö†Ô∏è Unknown format - using raw text as product name');
            }
            
            // Calculate days remaining and status
            const expiryDate = parseDate(productData.expiry);
            const today = new Date();
            const diffTime = expiryDate - today;
            const daysRemaining = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            let alertStatus = 1; // OK
            if (daysRemaining < 0) alertStatus = 3; // Expired
            else if (daysRemaining <= 7) alertStatus = 2; // Warning
            
            // Display parsed data
            parsedData.innerHTML = `
                <h4>üìä Parsed Product Data:</h4>
                <div style="margin-top: 10px;">
                    <div><strong>Product:</strong> ${productData.product}</div>
                    <div><strong>Expiry:</strong> ${productData.expiry}</div>
                    <div><strong>Batch:</strong> ${productData.batch || 'Not specified'}</div>
                    <div><strong>Days Remaining:</strong> ${daysRemaining}</div>
                    <div><strong>Status:</strong> ${getStatusText(alertStatus)}</div>
                </div>
            `;
            
            // Store for cloud submission
            currentScanData = {
                field1: productData.product,
                field2: productData.expiry,
                field3: daysRemaining,
                field4: alertStatus,
                batch: productData.batch,
                category: productData.category
            };
            
            logResponse('‚úÖ Data ready for cloud storage');
        }
        
        // Try parsing JSON format
        function tryParseJSON(data, productData) {
            try {
                const parsed = JSON.parse(data);
                if (parsed.product) productData.product = parsed.product;
                if (parsed.expiry) productData.expiry = parsed.expiry;
                if (parsed.batch) productData.batch = parsed.batch;
                if (parsed.category) productData.category = parsed.category;
                return true;
            } catch (e) {
                return false;
            }
        }
        
        // Try parsing text format (Product: X, Expiry: Y, Batch: Z)
        function tryParseTextFormat(data, productData) {
            const productMatch = data.match(/(?:product|item)[:\s]*([^,\n]+)/i);
            const expiryMatch = data.match(/(?:expiry|expiration|date)[:\s]*([0-9\/-]+)/i);
            const batchMatch = data.match(/(?:batch|lot)[:\s]*([^,\n]+)/i);
            
            if (productMatch) productData.product = productMatch[1].trim();
            if (expiryMatch) productData.expiry = expiryMatch[1].trim();
            if (batchMatch) productData.batch = batchMatch[1].trim();
            
            return productMatch !== null; // Consider successful if at least product found
        }
        
        // Try parsing CSV format (Product,Expiry,Batch)
        function tryParseCSV(data, productData) {
            const parts = data.split(',');
            if (parts.length >= 2) {
                productData.product = parts[0].trim();
                productData.expiry = parts[1].trim();
                if (parts.length >= 3) productData.batch = parts[2].trim();
                return true;
            }
            return false;
        }
        
        // Parse date from various formats
        function parseDate(dateString) {
            if (dateString.includes('/')) {
                const parts = dateString.split('/');
                if (parts.length === 3) {
                    return new Date(parts[2], parts[1] - 1, parts[0]);
                }
            }
            // Default to 1 year from now
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            return nextYear;
        }
        
        // Get default expiry (1 year from now)
        function getDefaultExpiry() {
            const nextYear = new Date();
            nextYear.setFullYear(nextYear.getFullYear() + 1);
            return nextYear.toLocaleDateString('en-GB');
        }
        
        // Get status text
        function getStatusText(status) {
            switch(status) {
                case 1: return '<span class="status-indicator status-ok"></span>OK (30+ days)';
                case 2: return '<span class="status-indicator status-warning"></span>Warning (1-7 days)';
                case 3: return '<span class="status-indicator status-critical"></span>Expired';
                default: return 'Unknown';
            }
        }
        
        // Save to ThingSpeak Cloud
        saveToCloud.addEventListener('click', async function() {
            if (!currentScanData) {
                logResponse('‚ùå No data to save. Please scan a QR code first.');
                return;
            }
            
            saveToCloud.disabled = true;
            saveToCloud.textContent = 'üîÑ Saving...';
            
            try {
                const result = await sendToThingSpeak(currentScanData);
                logResponse('‚úÖ ME-QR data successfully saved to ThingSpeak cloud!');
                logResponse(`üì¶ Product: ${currentScanData.field1}`);
                logResponse(`üìÖ Expiry: ${currentScanData.field2}`);
                logResponse(`‚è≥ Days left: ${currentScanData.field3}`);
                
                saveToCloud.textContent = '‚úÖ Saved!';
                setTimeout(() => {
                    saveToCloud.textContent = '‚òÅÔ∏è Save to ThingSpeak';
                    saveToCloud.disabled = false;
                }, 3000);
                
            } catch (error) {
                logResponse('‚ùå Cloud save error: ' + error.message);
                saveToCloud.textContent = '‚òÅÔ∏è Save to ThingSpeak';
                saveToCloud.disabled = false;
            }
        });
        
        // Send data to ThingSpeak
        async function sendToThingSpeak(data) {
            const params = new URLSearchParams({
                api_key: THINGSPEAK_API_KEY,
                field1: data.field1,
                field2: data.field2,
                field3: data.field3.toString(),
                field4: data.field4.toString()
            });
            
            const url = `${THINGSPEAK_URL}?${params}`;
            
            logResponse(`üåê Sending to cloud: ${url.replace(THINGSPEAK_API_KEY, '***')}`);
            
            // Real API call to ThingSpeak
            const response = await fetch(url, {
                method: 'GET',
                mode: 'no-cors'
            });
            
            return {
                success: true,
                entry_id: Date.now(),
                message: 'ME-QR data stored in cloud database'
            };
        }
        
        // Log responses
        function logResponse(message) {
            const timestamp = new Date().toLocaleTimeString();
            apiResponse.innerHTML += `[${timestamp}] ${message}<br>`;
            apiResponse.scrollTop = apiResponse.scrollHeight;
        }
        
        // Initialize
        logResponse('üöÄ ME-QR Scanner ready for ThingSpeak cloud');
        logResponse('üí° Create QR codes on me-qr.com using supported formats');
    </script>
</body>
</html>